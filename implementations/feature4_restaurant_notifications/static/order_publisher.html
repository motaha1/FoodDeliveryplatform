<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Simple Order Publisher</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin:0; background:#0f172a; color:#e2e8f0; }
    header { padding:16px 22px; background:#1e293b; display:flex; justify-content:space-between; align-items:center; }
    h1 { font-size:18px; margin:0; font-weight:600; }
    main { max-width:760px; margin:0 auto; padding:26px 22px 80px; }
    fieldset { border:1px solid #334155; border-radius:10px; padding:18px 20px 24px; margin:0 0 28px; }
    legend { padding:0 8px; font-size:12px; letter-spacing:.5px; font-weight:600; }
    label { font-size:11px; opacity:.75; display:block; margin:0 0 4px; }
    input, textarea { width:100%; background:#1e293b; border:1px solid #334155; color:#e2e8f0; border-radius:8px; padding:10px 12px; font-size:14px; font-family:inherit; }
    textarea { min-height:100px; resize:vertical; }
    .row { display:grid; grid-template-columns:repeat(auto-fit,minmax(190px,1fr)); gap:18px; }
    button { background:#3b82f6; color:#fff; border:none; padding:12px 20px; border-radius:8px; font-weight:600; cursor:pointer; letter-spacing:.4px; }
    button.secondary { background:#475569; }
    button.danger { background:#dc2626; }
    button:disabled { opacity:.55; cursor:not-allowed; }
    button:hover { filter:brightness(1.08); }
    .actions { display:flex; gap:14px; flex-wrap:wrap; margin-top:14px; }
    pre { background:#0f172a; border:1px solid #334155; padding:14px 16px; border-radius:8px; font-size:12px; max-height:260px; overflow:auto; }
    .badge { background:#334155; padding:2px 8px; border-radius:12px; font-size:11px; margin-left:6px; }
    footer { text-align:center; font-size:11px; opacity:.55; margin-top:50px; }
    #status { font-size:12px; background:#334155; padding:5px 10px; border-radius:16px; }
    .inline { display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; }
    .note { font-size:11px; opacity:.65; margin-top:6px; }
  </style>
</head>
<body>
<header>
  <h1>üõéÔ∏è Simple Order Publisher <span class="badge">POST /api/v1/orders</span></h1>
  <div id="status">Idle</div>
</header>
<main>
  <fieldset>
    <legend>API Target</legend>
    <div class="row">
      <div>
        <label>Base URL</label>
        <input id="apiBase" value="http://localhost:5002/api/v1" />
      </div>
    </div>
    <div class="note">Endpoint used: <code>POST /orders</code> (single Redis channel)</div>
  </fieldset>

  <fieldset>
    <legend>Quick JSON (optional)</legend>
    <label for="rawJson">Raw JSON (if present this overrides manual fields below)</label>
    <textarea id="rawJson" placeholder='{"items":["Pizza","Cola"],"total":32.4}'></textarea>
    <div class="note">Must be valid JSON. Leave empty to use manual form.</div>
  </fieldset>

  <fieldset>
    <legend>Manual Order Fields</legend>
    <div class="row">
      <div>
        <label>Total ($)</label>
        <input id="total" type="number" step="0.01" value="18.50" />
      </div>
      <div>
        <label>Items (comma)</label>
        <input id="items" value="Burger,Fries" />
      </div>
      <div>
        <label>Custom Order ID (optional)</label>
        <input id="orderId" type="number" placeholder="auto" />
      </div>
    </div>
    <div class="actions">
      <button id="sendBtn" type="button">Publish Order</button>
      <button type="button" class="secondary" id="sampleBtn">Sample JSON</button>
      <button type="button" class="danger" id="clearBtn">Clear</button>
    </div>
  </fieldset>

  <fieldset>
    <legend>Auto Mode</legend>
    <div class="inline">
      <div>
        <label>Interval (sec)</label>
        <input id="autoInterval" type="number" value="12" />
      </div>
      <div>
        <label>Random Item Pool</label>
        <input id="itemPool" value="Pizza,Pasta,Salad,Soup,Sandwich,Juice" />
      </div>
      <div>
        <label>Min Total</label>
        <input id="minTotal" type="number" value="8" />
      </div>
      <div>
        <label>Max Total</label>
        <input id="maxTotal" type="number" value="55" />
      </div>
      <div class="actions" style="margin:0;">
        <button id="autoToggle" type="button" class="secondary">Start Auto</button>
        <button id="autoStop" type="button" class="danger">Stop</button>
      </div>
    </div>
    <div class="note">Generates random orders and posts them periodically. Works well with the live SSE client.</div>
  </fieldset>

  <fieldset>
    <legend>Log <span class="badge" id="countBadge">0</span></legend>
    <pre id="log"></pre>
  </fieldset>

  <footer>Publishes orders to Redis channel via <code>POST /api/v1/orders</code>. Use the listener page to see them appear instantly (SSE).</footer>
</main>
<script>
  const logEl = document.getElementById('log');
  const statusEl = document.getElementById('status');
  const countBadge = document.getElementById('countBadge');
  let count = 0;
  let autoTimer = null;

  function apiBase(){
    return document.getElementById('apiBase').value.replace(/\/$/, '');
  }
  function log(msg, ok=true){
    count++; countBadge.textContent = count;
    const t = new Date().toLocaleTimeString();
    logEl.textContent = `[${t}] ${msg}\n` + logEl.textContent;
  }
  function setStatus(text){ statusEl.textContent = text; }

  function buildManual(){
    const total = parseFloat(document.getElementById('total').value)||0;
    const items = document.getElementById('items').value.split(',').map(s=>s.trim()).filter(Boolean);
    const idVal = document.getElementById('orderId').value.trim();
    const p = { total, items };
    if(idVal) p.order_id = parseInt(idVal,10);
    return p;
  }
  function randomOrder(){
    const pool = document.getElementById('itemPool').value.split(',').map(s=>s.trim()).filter(Boolean);
    const n = 1 + Math.floor(Math.random()*Math.min(4, pool.length||1));
    const shuffled = pool.sort(()=>0.5 - Math.random()).slice(0,n);
    const minT = parseFloat(document.getElementById('minTotal').value)||5;
    const maxT = parseFloat(document.getElementById('maxTotal').value)||50;
    const total = +(minT + Math.random()*(maxT-minT)).toFixed(2);
    return { items: shuffled, total };
  }
  async function publish(orderOverride){
    let payload;
    const raw = document.getElementById('rawJson').value.trim();
    if(raw){
      try { payload = JSON.parse(raw); } catch(e){ return log('Invalid JSON: '+e.message,false); }
    } else {
      payload = orderOverride || buildManual();
    }
    try {
      setStatus('Publishing...');
      const res = await fetch(`${apiBase()}/orders`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      const data = await res.json();
      if(res.ok){ log(`Published order #${data.message.order_id} ($${data.message.total ?? 'n/a'})`); }
      else { log('Error '+res.status+': '+JSON.stringify(data), false); }
    } catch(e){ log('Network error: '+e.message,false); }
    finally { setStatus('Idle'); }
  }
  function toggleAuto(){
    if(autoTimer){ stopAuto(); return; }
    const iv = parseInt(document.getElementById('autoInterval').value,10)||10;
    autoTimer = setInterval(()=> publish(randomOrder()), iv*1000);
    document.getElementById('autoToggle').textContent = 'Pause Auto';
    publish(randomOrder());
    log('Auto mode started every '+iv+'s');
  }
  function stopAuto(){
    if(autoTimer){ clearInterval(autoTimer); autoTimer=null; log('Auto mode stopped'); }
    document.getElementById('autoToggle').textContent = 'Start Auto';
  }
  function clearAll(){
    document.getElementById('rawJson').value='';
    document.getElementById('items').value='';
    document.getElementById('total').value='';
    document.getElementById('orderId').value='';
  }
  function sample(){
    document.getElementById('rawJson').value = JSON.stringify({ items:["Salad","Water"], total:11.75 }, null, 2);
  }

  document.getElementById('sendBtn').onclick = ()=> publish();
  document.getElementById('autoToggle').onclick = toggleAuto;
  document.getElementById('autoStop').onclick = stopAuto;
  document.getElementById('clearBtn').onclick = clearAll;
  document.getElementById('sampleBtn').onclick = sample;
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SSE Orders Feed (Read Only)</title>
  <style>
    body { font-family: Arial, sans-serif; background:#0f172a; color:#e2e8f0; margin:0; }
    header { background:#1e293b; padding:14px 20px; display:flex; justify-content:space-between; align-items:center; }
    h1 { margin:0; font-size:16px; }
    #status { font-size:12px; padding:4px 10px; border-radius:18px; background:#334155; }
    main { max-width:820px; margin:0 auto; padding:22px 18px 60px; }
    button { background:#3b82f6; color:#fff; border:none; padding:8px 14px; border-radius:6px; font-weight:600; cursor:pointer; }
    button.secondary { background:#475569; }
    button:disabled { opacity:.5; cursor:not-allowed; }
    #controls { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:18px; }
    .orders { display:grid; gap:10px; }
    .order { background:#1e293b; border:1px solid #334155; padding:10px 12px; border-radius:8px; font-size:13px; }
    .order.new { animation: pulse 1.6s ease; }
    @keyframes pulse { 0% { box-shadow:0 0 0 0 #22c55e55; } 70% { box-shadow:0 0 0 14px transparent; } 100% { box-shadow:0 0 0 0 transparent; } }
    .meta { font-size:11px; opacity:.7; margin-top:4px; }
    pre { margin:6px 0 0; background:#0f172a; padding:8px 10px; border-radius:6px; overflow:auto; font-size:12px; }
    #log { background:#0f172a; padding:10px 12px; border-radius:6px; font-size:12px; max-height:150px; overflow:auto; margin-top:24px; }
    footer { text-align:center; font-size:11px; opacity:.55; margin-top:40px; }
  </style>
</head>
<body>
<header>
  <h1>üçΩÔ∏è Live Orders (Read Only SSE)</h1>
  <div id="status">Disconnected</div>
</header>
<main>
  <section id="controls">
    <button id="connectBtn">Connect</button>
    <button id="disconnectBtn" class="secondary" disabled>Disconnect</button>
    <button id="clearBtn" class="secondary">Clear</button>
    <button id="autoscrollBtn" class="secondary">Auto-Scroll: ON</button>
  </section>

  <h3>Incoming Events</h3>
  <div class="orders" id="orders"></div>
  <div id="log"></div>
  <footer>Endpoint: GET /api/v1/orders/stream ‚Ä¢ This page only listens (no publishing).</footer>
</main>
<script>
  const API_BASE = 'http://localhost:5000/api/v1'; // adjust if server on 5000
  let es = null;
  let autoScroll = true;
  const statusEl = document.getElementById('status');
  const ordersEl = document.getElementById('orders');
  const logEl = document.getElementById('log');

  function log(msg){
    const t = new Date().toLocaleTimeString();
    logEl.innerHTML = `[${t}] ${msg}<br>` + logEl.innerHTML;
  }
  function setStatus(txt,color){
    statusEl.textContent = txt;
    statusEl.style.background = color;
  }
  function addOrder(obj){
    const div = document.createElement('div');
    div.className = 'order new';
    const id = obj.order_id ?? '‚Äî';
    const items = Array.isArray(obj.items)? obj.items.join(', ') : (obj.text || '');
    div.innerHTML = `<strong>Order #${id}</strong>` +
      `<div class="meta">Items: ${items || 'n/a'} ‚Ä¢ Total: $${obj.total ?? '‚Äî'} ‚Ä¢ ${new Date((obj.created_ts||Date.now()/1000)*1000).toLocaleTimeString()}</div>`+
      `<pre>${JSON.stringify(obj,null,2)}</pre>`;
    ordersEl.prepend(div);
    if(autoScroll){ window.scrollTo({ top:0, behavior:'smooth' }); }
  }
  function connect(){
    if(es) es.close();
    es = new EventSource(`${API_BASE}/orders/stream`);
    setStatus('Connecting‚Ä¶','#92400e');
    log('Opening SSE connection');
    es.onopen = ()=>{ setStatus('Connected','#166534'); log('SSE open'); };
    es.onerror = ()=>{ setStatus('Disconnected','#991b1b'); log('SSE error (auto-retry by browser)'); };
    es.onmessage = e => {
      try { const data = JSON.parse(e.data); addOrder(data); log(`Event order_id=${data.order_id}`); }
      catch(err){ log('Bad JSON: '+err.message); }
    };
    document.getElementById('connectBtn').disabled = true;
    document.getElementById('disconnectBtn').disabled = false;
  }
  function disconnect(){
    if(es){ es.close(); es=null; }
    setStatus('Disconnected','#991b1b');
    log('Disconnected manually');
    document.getElementById('connectBtn').disabled = false;
    document.getElementById('disconnectBtn').disabled = true;
  }
  document.getElementById('connectBtn').onclick = connect;
  document.getElementById('disconnectBtn').onclick = disconnect;
  document.getElementById('clearBtn').onclick = ()=> { ordersEl.innerHTML=''; log('Cleared view'); };
  document.getElementById('autoscrollBtn').onclick = (e)=>{
    autoScroll = !autoScroll;
    e.target.textContent = 'Auto-Scroll: ' + (autoScroll? 'ON':'OFF');
  };
</script>
</body>
</html>
